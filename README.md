# Курсовая работа по курсу "Проектирование высоконагруженных систем"  
**Студент**: Фролов И.О. WEB-31 (Осень 2025)  
# CoinBase (Централизованная криптовалютная биржа)

---

## 1. Тема и целевая аудитория

**Тип сервиса**: Криптовалютная биржа и кошелек  
**Целевая аудитория**: Глобальная (США и ЕС в приоритете, за исключением стран с полным запретом криптовалюты) [1]  

- **MAU (Monthly Active Users)**: **120 миллионов** — общее число пользователей, взаимодействующих с платформой ежемесячно (просмотр курсов, портфеля, новостей) [1]  
- **MTU\* (Monthly Transacting Users)**: **8.7 миллионов** — пользователи, совершающие хотя бы одну торговую операцию в месяц (Q2 2025) [1]  
- **DAU (Daily Active Users)**: **~4.3 миллиона** — консервативная оценка, основанная на предположении, что 50% активных трейдеров (MTU) заходят ежедневно для торговли или мониторинга позиций [1]  

> **Примечание**: Coinbase перешла на отчетность по MTU как ключевой метрике активности, так как именно транзакционные пользователи генерируют основной доход. Большинство из 120M MAU — пассивные держатели или читатели контента.

**Ключевой функционал**: Торговые операции с криптовалютой (купля/продажа, обмен, вывод)  
**Ключевое продуктовое решение**: Хранение средств пользователей на кошельках платформы с внутренним matching engine для исполнения ордеров [3]

**Основной функционал MVP**:
- Регистрация и прохождение KYC-верификации (подтверждение личности) // LKS, Verify, Auth
- Пополнение/Вывод баланса фиатными валютами (USD, EUR и др.) // Кошелёк
- Покупка/продажа криптовалюты по рыночной цене (маркет-ордера с минимальной задержкой)
- Отправка/получение криптовалюты на внешние кошельки // К кошельку
- Просмотр истории транзакций, текущего баланса // К Кошельку
- Получение актуальных курсов в реальном времени (с минимальной задержкой)
- Комиссия за исполнение ордера и пополнение/вывод // Монетизация
- Монетизация по информации о сделках // !TODO
---

## 2. Расчет нагрузки

**Продуктовые метрики (на основе данных Q2 2025 и усреднённых показателей 2025 года)**:

- **Ежемесячный объем торговли (Trading Volume)**: ~$310 млрд в месяц (усреднённый показатель за 2025 год) [1]  

- **Transaction Revenue (доход от комиссий)**: **$6.71 млрд TTM** → **~$560 млн в месяц** [1]  
→ **Средняя комиссия**: **~0.18%** ($560 млн / $310 млрд)  
→ **Средний объем торговли на одного MTU**: **~$35,632 в месяц** ($310 млрд / 8.7 млн MTU) [1]  

- **Средний размер сделки**: **$115** — типичный чек для розничного трейдера на Coinbase [расчитано]  
→ **Ежемесячное количество сделок**: **~2.7 миллиарда** ($310 млрд / $115)  
*(Примечание: В архитектуре matching engine под “сделкой” может пониматься исполнение части ордера — общее число ордеров может быть меньше)*

- **Число верифицированных пользователей**: **120 миллионов** [1]  
- **Количество поддерживаемых криптоактивов для розницы**: **313** (для MVP 250+) [1]  
### Продуктовые метрики

| Метрика | Значение | Комментарий / Источник |
|--------|----------|-------------------------|
| **MAU (Monthly Active Users)** | 120 млн | Все пользователи, заходящие на платформу хотя бы раз в месяц (включая пассивных) [1] |
| **MTU (Monthly Transacting Users)** | 8.7 млн | Пользователи, совершившие хотя бы 1 торговую операцию в месяц (Q2 2025) [1] |
| **DAU (Daily Active Users)** | ~4.3 млн | Оценка: 50% от MTU заходят ежедневно для торговли/мониторинга (основано на типичной активности трейдеров) [1] |
| **Средний размер хранилища на пользователя** | **~10 MB** | 8.5 MB (KYC + профиль) + 1.5 MB (720 транзакций) — хранение в объектном хранилище или СУБД |
| **Среднее количество действий на DAU в день** | | |
| — Просмотр курсов / портфеля | 20 запросов | UI-запросы к API цен и балансов |
| — Торговые операции (маркет-ордера) | 24 операции | Создание и исполнение ордеров |
| — Пополнение/вывод фиата | 0.05 операций | Через банковские шлюзы или карты |
| — Перевод криптовалюты на внешний адрес | 0.03 операций | On-chain транзакции |

### Технические метрики: Размер хранения данных (в штуках и ТБ)

| Тип данных | Кол-во записей (шт) | Средний размер на запись | Общий объем | Комментарий |
|------------|---------------------|--------------------------|-------------|-------------|
| **Пользовательские профили (KYC + данные)** | 120 млн | 8.5 MB | **~1.02 PB** | Хранение документов, фото, метаданных — долгосрочное |
| **История транзакций (720 на пользователя)** | 86.4 млрд | 22 байта (ID, сумма, валюта, timestamp) | **~1.9 TB** | Основной объем — метаданные, не бинарные данные |
| **Ордера (ежемесячно)** | 2.7 млрд | 256 байт (ID, цена, объем, статус, юзер ID, комиссия) | **~691 GB/мес** → **~8.3 TB/год** | Хранятся до исполнения, затем архивируются для аналитики |
| **Котировки (цены) в реальном времени** | 250 активов × 60 сек × 86400 = 1.3 млрд в день | 32 байта (валюта, цена, timestamp) | **~42 GB/день** → **~15.3 TB/год** | Только изменения цен с минимальной задержкой |
| **Логи действий пользователей (audit logs)** | 4.3 млн DAU × 44.08 операций/день = 189.5 млн/день | 512 байт | **~97.0 GB/день** → **~35.4 TB/год** | Для аналитики, безопасности, compliance |
| **ИТОГО (активные + архивные данные за 1 год)** | — | — | **~1.06 PB** | Основной объем — профили и KYC-данные |

### Сетевой трафик

#### Пиковое потребление в течение суток (Гбит/с)

| Тип трафика | Пиковая нагрузка (Гбит/с) | Расчёт | Комментарий |
|-------------|---------------------------|--------|-------------|
| **UI/API запросы (курсы, балансы, портфель)** | 12.8 Гбит/с | `(4.3M × 20 × 2 KB) / (86400 × 0.1)` | Пик в часы открытия рынков США/ЕС |
| **Торговые ордера (создание/исполнение)** | 16.8 Гбит/с | `(4.3M × 24 × 0.5 KB) / (86400 × 0.1)` | Пик при волатильности рынка |
| **Поток цен (WebSocket / SSE)** | 5.1 Гбит/с | `250 активов × 1 обновление/сек × 64 байта × 4.3 млн DAU` | Рассылка всем подписчикам в реальном времени |
| **Фоновые синхронизации (KYC, логи, аналитика)** | 2.0 Гбит/с | Оценка на основе ETL-процессов | Асинхронные задачи, репликация, бэкапы |
| **ИТОГО ПИКОВАЯ НАГРУЗКА** | **~36.7 Гбит/с** | — | Требуется сетевая инфраструктура с запасом — минимум 40 Гбит/с на фронтендах |

> **Формула расчета пика**:  
> `(Количество запросов в день × Размер запроса в байтах × 8) / (86400 сек × Коэффициент пиковой нагрузки)`  
> **Коэффициент пиковой нагрузки = 0.1** (пик в 10 раз выше среднего — стандарт для финансовых систем).

#### Суточный трафик (ГБ/сутки)

| Тип трафика | Суточный объем (ГБ) | Расчёт |
|-------------|---------------------|--------|
| UI/API запросы | 1660 ГБ | 4.3M × 20 × 2 KB × 8 / 8 (бит → байт) |
| Торговые ордера | 2196 ГБ | 4.3M × 24 × 0.5 KB × 8 / 8 |
| Поток цен | 665.6 ГБ | 250 × 86400 × 64 × 4.3M / 10⁹ |
| Фоновые процессы | 260 ГБ | Оценка |
| **ИТОГО** | **~4782 ГБ/сутки** | — |

### RPS (Requests Per Second)

| Тип запроса | Средний RPS | Пиковый RPS (x10) | Расчёт | Комментарий |
|-------------|-------------|-------------------|--------|-------------|
| **Получение курсов / портфеля (GET /api/v1/prices, /balance)** | 9,954 RPS | 99,540 RPS | `(4.3M × 20) / 86400` | Основная нагрузка на API-шлюзы и кэш |
| **Создание рыночного ордера (POST /api/v1/orders)** | 11,952 RPS | 119,520 RPS | `(4.3M × 24) / 86400` | Нагрузка на matching engine и кошельки |
| **Пополнение/вывод фиата (POST /api/v1/fiat)** | 25 RPS | 250 RPS | `(4.3M × 0.05) / 86400` | Интеграция с банковскими API |
| **Перевод криптовалюты (POST /api/v1/transfer)** | 15 RPS | 150 RPS | `(4.3M × 0.03) / 86400` | On-chain транзакции, взаимодействие с блокчейн-нодами |
| **WebSocket подписки на цены** | 107,500 RPS | 1,075,000 RPS | `250 активов × 4.3 млн DAU` | Не HTTP-запросы, а частота рассылки сообщений сервером |
| **Аутентификация / сессии (GET /auth, POST /login)** | 5,000 RPS | 50,000 RPS | Оценка на основе DAU и частоты входа/обновления токенов | Нагрузка на сервис аутентификации и Redis |

---

## 3. Глобальная балансировка нагрузки

### Функциональное разбиение по доменам

Для масштабируемости и изоляции ответственности архитектура Coinbase-подобного сервиса разбивается на следующие функциональные домены:

| Домен | Ответственность | Примеры эндпоинтов / сервисов |
|-------|------------------|-------------------------------|
| **Auth & KYC** | Регистрация, аутентификация, верификация личности | `/auth/login`, `/kyc/submit`, `/profile/verify` |
| **Trading Engine** | Исполнение ордеров, управление стаканом, расчет цен | Matching Engine, Order Book Service |
| **Wallet & Custody** | Хранение средств, пополнение/вывод фиата и криптовалюты | `/wallet/balance`, `/fiat/deposit`, `/crypto/withdraw` |
| **Market Data** | Доставка цен в реальном времени, исторические котировки | WebSocket `/stream/prices`, `/api/v1/prices/{asset}` |
| **User Activity & Logs** | Аудит действий, аналитика, compliance | Audit Log Service, Event Bus |
| **Notifications & Alerts** | Push/SMS/email уведомления о сделках, ценах | Notification Service |

Такое разбиение позволяет независимо масштабировать каждый домен в зависимости от нагрузки и требований к доступности.

### Обоснование расположения дата-центров (ДЦ)

Coinbase — глобальный сервис с фокусом на регулируемые рынки, особенно США и Европу. Согласно отчетам, **65% рынка США** принадлежит Coinbase [1], а также значительная доля пользователей приходится на ЕС.

**Выбранные регионы размещения ДЦ**:
- **США (Восточное побережье)** — DigitalOcean `nyc3` (Нью-Йорк)  
  → Близость к финансовым центрам и пользователям США. Минимальная задержка для трейдеров.
- **Европа (Запад)** — DigitalOcean `ams3` (Амстердам)  
  → Соответствие GDPR, низкая задержка для всей континентальной Европы благодаря AMS-IX.
- **Азиатско-Тихоокеанский регион (перспектива)** — DigitalOcean `sgp1` (Сингапур)  
  → Для будущего масштабирования в APAC (в MVP не используется, так как основной трафик — США/ЕС).

**Влияние на продуктовые метрики**:
- Задержка до пользователя в США/ЕС < 30 мс → критично для исполнения рыночных ордеров.
- Соответствие требованиям регуляторов (SEC, MiCA) — хранение KYC-данных в юрисдикции пользователя.

### Распределение запросов по дата-центрам

На основе географического распределения пользователей (оценка на основе доли рынка [1]):
- **70% MTU** — США и Канада → обслуживается ДЦ `nyc3`
- **25% MTU** — Европа → обслуживается ДЦ `ams3`
- **5% MTU** — остальной мир → перенаправляется в ближайший ДЦ (в основном `nyc3`)

**Распределение пиковой нагрузки (на основе RPS из раздела 2)**:

| Тип запроса | Общий пиковый RPS | `nyc3` (70%) | `ams3` (25%) | Остальные (5%) |
|-------------|-------------------|--------------|--------------|----------------|
| Получение курсов / баланса | 99,540 | 69,678 | 24,885 | 4,977 |
| Создание ордеров | 119,520 | 83,664 | 29,880 | 5,976 |
| WebSocket цены | 1,075,000 | 752,500 | 268,750 | 53,750 |
| Аутентификация | 50,000 | 35,000 | 12,500 | 2,500 |

> Wallet-операции (пополнение/вывод) и on-chain транзакции обрабатываются централизованно в `nyc3` из-за интеграции с американскими банками и требованиями compliance.

### Схема DNS-балансировки

Используется **географическая DNS-балансировка** через Cloudflare Load Balancing:

- Запрос к `api.***.com` → Cloudflare определяет геолокацию клиента по IP.
- Возвращает IP-адрес ближайшего Load Balancer:
  - США/Канада → Load Balancer в `nyc3`
  - Европа → Load Balancer в `ams3`
  - Остальные → Load Balancer в `nyc3` (fallback)

**Преимущества**:
- Минимизация задержки
- Изоляция сбоев по регионам
- Простота управления

### Схема Anycast-балансировки

Для **WebSocket-потока цен** и **публичных API котировок** применяется **Anycast** через Cloudflare Spectrum:

- Один IP-адрес объявляется глобально через сеть Cloudflare.
- BGP-маршрутизация направляет клиента к ближайшему PoP.
- Серверы в `nyc3` и `ams3` публикуют одинаковые данные (цены реплицируются асинхронно между регионами через зашифрованный поток данных поверх публичного интернета. Задержка репликации составляет 70–100 мс, что приемлемо для публичных котировок, не влияющих на исполнение торговых операций).

**Эффект**:
- Задержка доставки цены < 10 мс в пределах региона
- Устойчивость к DDoS (трафик рассеивается)
- Прозрачность для клиента

> Anycast используется только для **read-only** данных (цены, общедоступная информация). Запись (ордера, транзакции) всегда идет через гео-DNS в домашний регион пользователя.

// TODO: Реплицированная логика
// Децентрализованное хранение

### Механизм регулировки трафика между ДЦ

Для обеспечения отказоустойчивости и балансировки при пиковой нагрузке используется:

1. **Health Checks + Failover**  
   Cloudflare постоянно проверяет здоровье Load Balancer в каждом ДЦ. При падении одного региона — весь трафик перенаправляется в резервный.

2. **Weighted Routing (динамическое перераспределение)**  
   При приближении к лимиту RPS в одном ДЦ (например, `nyc3` > 90% capacity), система автоматически снижает вес региона и перенаправляет часть трафика в `ams3` (даже для US-пользователей), с уведомлением о возможном росте задержки.
    // Больше конкретики и технологий, протоколы и тп
3. **Rate Limiting на уровне CDN**  
   Cloudflare Rate Limiting ограничивает RPS на пользователя и IP, предотвращая перегрузку бэкенда.

4. **Глобальный кэш курсов**  
   Cloudflare кэширует публичные цены на 1–2 секунды, снижая нагрузку на origin-серверы на 60–70%.

Такой подход обеспечивает **высокую доступность (99.99%)** и **предсказуемую производительность** даже при всплесках волатильности рынка.

---

## 4. Локальная балансировка нагрузки

### Схема балансировки нагрузки

Локальная балансировка реализуется в каждом дата-центре (`nyc3`, `ams3`) и состоит из следующих уровней:

1. **L4 Load Balancer (TCP forwarding)**  // Заменить на низкоуровневое решение чтобы дойти до L7
   - Размещён перед NGINX Ingress Controller внутри дата-центра.  
   - Принимает HTTP-трафик от Cloudflare и распределяет его по инстансам NGINX Ingress.  
   - TLS termination выполняется на Cloudflare, поэтому L4 работает без шифрования.  
   - Это **lightweight-компонент** (например, HAProxy/Envoy) — **2 инстанса на регион** (1 активный + 1 резервный).  
   - Резервирование: **N+1**.

2. **NGINX Ingress Controller (L7 Routing)**  
   - Работает в режиме DaemonSet на выделенных нодах Kubernetes.  
   - Маршрутизирует запросы к микросервисам по Host/Path (`/api/v1/orders`, `/auth`, `/wallet` и др.).  
   - Поддерживает WebSocket-соединения для потока цен.  
   - Резервирование: **N\*2** (сервисы и Ingress развернуты в двух зонах доступности внутри ДЦ).

3. **Внутренняя балансировка (Service Mesh / kube-proxy)**  
   - Основной трафик между подами маршрутизируется с помощью **Cilium** в режиме **eBPF**, без использования `kube-proxy` и `iptables`. Это обеспечивает O(1)-сложность маршрутизации, минимальную задержку и встроенную L7-наблюдаемость через Hubble.  
   - Для критически важных компонентов — таких как **Matching Engine** — применяется **sidecar-балансировка на основе Envoy Proxy** с поддержкой обеспечения балансировки вызовов через gRPC и weighted round-robin алгоритмов. Это позволяет точно контролировать распределение торговых ордеров между репликами движка и минимизировать tail latency (< 1 мс).

> **Формулы резервирования**:  
> - L4-балансировщики: **N+1**  
> - Ingress и сервисы: **N\*2**

### Расчёт количества балансировщиков

Расчёт выполняется на основе **пиковых RPS** из раздела 2 :

| Тип запроса | Пиковый RPS (глобально) |
|-------------|--------------------------|
| Получение курсов / баланса | 99 540 |
| Создание ордеров | 119 520 |
| Аутентификация | 50 000 |

> WebSocket-рассылка (1 075 000 RPS) не учитывается в SSL TPS — это сервер-инициированный трафик без TLS handshake.

#### Ограничитель 1: SSL Termination (TPS)

Согласно тестам NGINX Ingress Controller в Kubernetes [6]:
- На **24 CPU с Hyper-Threading** достигается **~56 700 SSL TPS** (новых TLS-соединений в секунду).

При использовании `keep-alive` (стандарт для клиентов), число **новых TLS-соединений ≈ 25% от пикового RPS**.

Для ДЦ `nyc3` (70% трафика):
- HTTPS RPS: `(99 540 + 119 520 + 50 000) × 0.7 ≈ 188 342 RPS`  
- Новые TLS-соединения: `188 342 × 0.25 ≈ 47 086 TPS`

Для ДЦ `ams3` (25% трафика):
- HTTPS RPS: `269 060 × 0.25 ≈ 67 265 RPS`  
- Новые TLS-соединения: `67 265 × 0.25 ≈ 16 816 TPS`

**Вывод**:  
- `nyc3`: 47 086 TPS < 56 700 → **1 активный NGINX Ingress достаточно**, но по политике **N\*2** → **2 инстанса**.  
- `ams3`: 16 816 TPS → **1 инстанс с запасом**, но по **N\*2** → **2 инстанса**.

#### Ограничитель 2: Пропускная способность сети

Пиковая суммарная нагрузка: **~36.7 Гбит/с** (глобально).  
- `nyc3`: 70% → **~25.7 Гбит/с**  
- `ams3`: 25% → **~9.2 Гбит/с**

Из тестов NGINX как веб-сервера [5]:
- При 16+ CPU достигается **~70–72 Гбит/с** на 2×40G сетевых интерфейсах.

**Вывод**:  
- `nyc3`: 2 инстанса × 2×40G → суммарно 160 Гбит/с (с запасом).  
- `ams3`: 2 инстанса × 1×40G → 80 Гбит/с (с запасом).

### Итоговая конфигурация

| ДЦ | NGINX Ingress Controller | CPU на инстанс | Сетевой интерфейс | Резервирование |
|----|---------------------------|----------------|-------------------|----------------|
| `nyc3` | 2 | 24 (HT включен) | 2× 40 Гбит/с | N\*2 |
| `ams3` | 2 | 24 (HT включен) | 1× 40 Гбит/с | N\*2 |

---

## Список используемых источников

1. **Coinbase Users Statistics (2025) – Worldwide Data**  
   https://www.demandsage.com/coinbase-users-statistics/    
2. **Coinbase Q2 2025 Financial Data & Shareholder Reports**  
   https://s27.q4cdn.com/397450999/files/doc_financials/2025/q2/Q2-2025-Shareholder-Letter.pdf  
3. **Example of matching engine**  
   https://github.com/enewhuis/liquibook
4. **Coinbase Q2 2025 Shareholder Letter**  
   https://s27.q4cdn.com/397450999/files/doc_financials/2025/q2/Q2-2025-Shareholder-Letter.pdf
5. **NGINX Web Server Performance Testing (2017)**  
   https://blog.nginx.org/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers
6. **NGINX Ingress Controller Performance in Kubernetes (2019)**  
   https://blog.nginx.org/blog/testing-performance-nginx-ingress-controller-kubernetes

> *MTU — Monthly Transacting Users (ежемесячно совершающие торговые операции)*
